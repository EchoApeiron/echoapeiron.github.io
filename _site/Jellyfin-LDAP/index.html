<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>

    
    <meta name="description" content="Onto what is currently the final installment of my Jellyfin server expedition. So far we have done some base server setup, configured the base application, did some networking to enable remote access, and deployed a reverse proxy to do our SSL offloading. Quite a bit, and if you need a review here are the links to the previous blog post:
" />
    <meta property="og:description" content="Onto what is currently the final installment of my Jellyfin server expedition. So far we have done some base server setup, configured the base application, did some networking to enable remote access, and deployed a reverse proxy to do our SSL offloading. Quite a bit, and if you need a review here are the links to the previous blog post:
" />
    
    <meta name="author" content="Dion Pezzimenti" />

    
    <meta property="og:title" content="Jellyfin, Centralizing Authentication with AD" />
    <meta property="twitter:title" content="Jellyfin, Centralizing Authentication with AD" />
    
    <title>Jellyfin, Centralizing Authentication with AD – Dion Pezzimenti – Technology Enthusiast</title>
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" href="/images/icons/fav.ico">
    <link rel="icon" type="image/png" href="/images/icons/fav-192.png" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/icons/fav-180.png">
    <link rel="alternate" type="application/rss+xml" title="Dion Pezzimenti - Technology Enthusiast" href="/feed.xml" />
</head>
<body>
    <header>
            <div class="site-info">
                <div class="site-avatar">
                    <a href="/"><img src="https://www.flaticon.com/svg/static/icons/svg/189/189001.svg" /></a>
                </div>
                <div class="header-text">
                    <a class="header-title" href="/">Dion Pezzimenti</a>
                    <p>Technology Enthusiast</p>
                </div>
            </div>
            <nav class="site-nav">
                <ul>
                    <li><a href="/">Home</a></li>
                    <li><a href="/about/index.html">About</a></li>
                </ul>
            </nav>
    </header>
    <section class="masthead"></section>
    <main class="container">
        <article class="post">
  <h1>Jellyfin, Centralizing Authentication with AD</h1>

  <div class="entry">
    <p>Onto what is currently the final installment of my Jellyfin server expedition. So far we have done some base server setup, configured the base application, did some networking to enable remote access, and deployed a reverse proxy to do our SSL offloading. Quite a bit, and if you need a review here are the links to the previous blog post:</p>

<ul>
  <li><a href="/Jellyfin-Initial">Jellyfin, Setting up the Server</a></li>
  <li><a href="/Jellyfin-SSL">Jellyfin, Securing with SSL Certificates</a></li>
</ul>

<p>Now we are going to do one other really cool thing and tie not only the application but our server into our central authentication server. For this we will be using the old trite and true Microsoft Active Directory. One Windows dominates with this technology and two it works very well out of the box with minimal configuration. We may touch on a few things like OUs, Users, and Groups. Beyond that though it will be assumed you have a Domain Controller or some sort of LDAP server already deployed. As we will be using LDAP specifically any LDAP server will be sufficient. You will need to know how to get your own Distinguished Names (or DNs as they are referred to sometimes).</p>

<h3 id="linux-and-active-directory">Linux and Active Directory</h3>

<p>I remember the first time I attempted to do this… and it was a massive failure back in 2010. While possible it was a difficult to achieve task. Then winbind got very mature and was doing work in conjunction with Samba. Now you will see just how simple it can be to tie  your Linux server to Active Directory. Which means you have no excuse to keep doing it going into the future.</p>

<p>First we need to install the required packages. The main biggies are going to be realmd, sssd, some PAM modules, and some other supplementary stuff for directory creation and the sorts. You can install the required software running the command below:</p>

<p><code class="language-plaintext highlighter-rouge">root@server:~# apt -y install realmd sssd sssd-tools libnss-sss libpam-sss adcli samba-common-bin oddjob oddjob-mkhomedir packagekit</code></p>

<p>Since Active Directory is very DNS driven we need to make sure we can communicate with the DNS server that is hosting the zone for our Active Directory. You can do this by using Netplan (which you may have used to configure your static… I didn’t for this for sake of ease). For this we just make a small config change to a YAML file in the Netplan configuration you can find it using the <code class="language-plaintext highlighter-rouge">ls</code> command on the <code class="language-plaintext highlighter-rouge">/etc/netplan</code> directory. Then simply back it up and edit as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp /etc/netplan/01-netcfg.yaml /etc/netplan/01-netcfg.yaml.bkup
vim /etc/netplan/01-netcfg.yaml
...

    nameservers:
      addresses: [192.168.0.100]

netplan apply 
</code></pre></div></div>

<p>One important fact about YAML is that tab characters are illegal. So be sure that you are indenting using only the spacebar or it will break the file. We then need to discover the domain using our <code class="language-plaintext highlighter-rouge">realm</code> command and should get an output like the following if everything is working properly, and your server can communicate with the Active Directory server’s DNS:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@hinata:/etc/netplan# realm discover domain.com
domain.com
  type: kerberos
  realm-name: DOMAIN.COM
  domain-name: domain.com
  configured: kerberos-member
  server-software: active-directory
  client-software: sssd
  required-package: sssd-tools
  required-package: sssd
  required-package: libnss-sss
  required-package: libpam-sss
  required-package: adcli
  required-package: samba-common-bin
  login-formats: %U
  login-policy: allow-realm-logins
</code></pre></div></div>

<p>With the domain discoverable this means we can then join it. To do so we are going to specify a user that isn’t the Administrator account (in my domain it is disabled). If you are using your Administrator account you don’t need to specify a user, but otherwise do as I do with the join command below:</p>

<p><code class="language-plaintext highlighter-rouge">realm join -U admin_user domain.com</code></p>

<p>You will then be prompted for the password. If everything worked you will get no notification which can be daunting but rest assured that’s good. If an error is thrown then that’s bad. Before we are able to test any users though we have to make some changes to PAM (Pluggable Authentication Module). Make a backup of the config file, but edit the file below as shown and then add the following entry as the very last line of the file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim /etc/pam.d/commoon-session
...

session optional        pam_mkhomedir.so skel=/etc/skel umask=077
</code></pre></div></div>

<p>That will make sure home directories are created as our domain users login to the server. Now we can do do a test to make sure we can switch into a domain user. We can use the <code class="language-plaintext highlighter-rouge">su</code> command to accomplish this as so:</p>

<p><code class="language-plaintext highlighter-rouge">root@dlp:~# su - domain_user@domain.com</code></p>

<p>If everything works correctly you should see the prompt of your CLI change:</p>

<p><code class="language-plaintext highlighter-rouge">domain_user@domain.com@server:~$</code></p>

<p>One final thing you can do but this is optional is make it to where you can omit the domain name. You do this by modifying the sssd.conf file:</p>

<p><code class="language-plaintext highlighter-rouge">vim /etc/sssd/sssd.conf</code></p>

<p>You want to find the directive <code class="language-plaintext highlighter-rouge">use_fully_qualified_names</code> and set it’s value to <code class="language-plaintext highlighter-rouge">False</code>. It is case sensative so you have to type False exactly like that. Just be sure to restart the sssd daemon to make the change take effect:</p>

<p><code class="language-plaintext highlighter-rouge">systemctl restart sssd.service</code></p>

<p><strong><em>Again all this is optional!</em></strong> Even the next part is optional but for those who have used AD you can already see the beauty of being able to have all your logins managed from this central source. But now that we can use our AD users on our Linux system there are some other things you might want to do. Like add certain users to the sudoers group. But for now we are going to move on and focus on integrating Jellyfin in with AD.</p>

<h3 id="jellyfin-and-the-ldap-plugin">Jellyfin and the LDAP Plugin</h3>

<p>The LDAP plugin itself is super simple to install. We just need to access the Plugins menu from the Admin Dashboard in Jellyfin. Then click on repositories and the LDAP plugin should be the first to appear in the respository (at least this was the case for me):</p>

<p><img src="https://drive.google.com/uc?export=view&amp;id=1iefLZu_xRKfMWSVHqa-TLaapjmBkBguf" alt="Jellyfin Plugins Menu" height="450px" /></p>

<p>Once the plugin is installed you will need to restart the <code class="language-plaintext highlighter-rouge">jellyfin</code> service itself:</p>

<p><code class="language-plaintext highlighter-rouge">systemctl restart jellyfin.service</code></p>

<p>From there you have two different approaches to how you can modify the configuration for this. You can either enter the values in the web portal or modify the configuration file located in the following directory (at least for me):</p>

<p><code class="language-plaintext highlighter-rouge">/var/lib/jellyfin/plugins/configurations</code></p>

<p>From there you can modify the <code class="language-plaintext highlighter-rouge">LDAP-Auth.xml</code> file. Below is the example of my configuration file, but I will explain what each value means:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?xml version="1.0"?&gt;
&lt;PluginConfiguration xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema"&gt;
  &lt;LdapServer&gt;directory.server.com&lt;/LdapServer&gt;
  &lt;LdapBaseDn&gt;DC=server,DC=com&lt;/LdapBaseDn&gt;
  &lt;LdapPort&gt;389&lt;/LdapPort&gt;
  &lt;LdapSearchAttributes&gt;SamAccountName&lt;/LdapSearchAttributes&gt;
  &lt;LdapUsernameAttribute&gt;SamAccountName&lt;/LdapUsernameAttribute&gt;
  &lt;LdapSearchFilter&gt;(memberOf=CN=Jellyfin-Users,OU=O-Groups,DC=server,DC=com)&lt;/LdapSearchFilter&gt;
  &lt;LdapAdminFilter&gt;(memberOf=CN=Jellyfin-Admins,OU=O-Groups,DC=server,DC=com)&lt;/LdapAdminFilter&gt;
  &lt;LdapBindUser&gt;CN=Jellyfin LDAP,OU=Service-Accounts,OU=O-Users,DC=server,DC=com&lt;/LdapBindUser&gt;
  &lt;LdapBindPassword&gt;J3llyfin&lt;/LdapBindPassword&gt;
  &lt;CreateUsersFromLdap&gt;true&lt;/CreateUsersFromLdap&gt;
  &lt;UseSsl&gt;false&lt;/UseSsl&gt;
  &lt;UseStartTls&gt;false&lt;/UseStartTls&gt;
  &lt;SkipSslVerify&gt;false&lt;/SkipSslVerify&gt;
&lt;/PluginConfiguration&gt;
</code></pre></div></div>

<p>There is a lot going on in this configuration. Firstly we have these three values that really help to define how we will connect and start searching our domain:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;LdapServer&gt;directory.server.com&lt;/LdapServer&gt;
&lt;LdapBaseDn&gt;DC=server,DC=com&lt;/LdapBaseDn&gt;
&lt;LdapPort&gt;389&lt;/LdapPort&gt;
</code></pre></div></div>

<p>Our <em>LdapServer</em> is the main node we will be using to integrate to our AD environment. As well it will be the one we issue all our LDAP requests to. For our <em>LdapBaseDn</em> it refers to the starting location in the Organizational Units to start searching in the domain. For this we pretty much specify the base domain as the search start. And the <em>LdapPort</em> is just the port that will be used to form the LDAP socket for queries.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;LdapSearchAttributes&gt;SamAccountName&lt;/LdapSearchAttributes&gt;
&lt;LdapUsernameAttribute&gt;SamAccountName&lt;/LdapUsernameAttribute&gt;
</code></pre></div></div>

<p>These two attributes pretty much state what we are looking for as a value to check against for our authentication. It is a Name Attribute specific to Windows domains. So we will gloss over it as it is still a pretty widely used field.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;LdapSearchFilter&gt;(memberOf=CN=Jellyfin-Users,OU=O-Groups,DC=server,DC=com)&lt;/LdapSearchFilter&gt;
&lt;LdapAdminFilter&gt;(memberOf=CN=Jellyfin-Admins,OU=O-Groups,DC=server,DC=com)&lt;/LdapAdminFilter&gt;
</code></pre></div></div>

<p>These two filters though are extremely important. These two don’t just simply look for Organizational Units in our directory. They go and look for specific User Groups in our directory. Check who the members of these groups are and then enables them to be created in Jellyfin. However I did notice a small glitch. The admin group doesn’t seem to work correctly. But you definitely want to utilize the <code class="language-plaintext highlighter-rouge">LdapSearchFilter</code> as this will dictate the users in your directory that can use the app.</p>

  </div>

  <div class="date">
    Written on October 20, 2020
  </div>

  
<div class="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">

	    var disqus_shortname = 'echoapeiron-blog';

	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();

	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

</article>

    </main>
    <footer>
        
<a href="mailto:dion.pezzimenti@protonmail.com"><i class="svg-icon email"></i></a>


<a href="https://github.com/EchoApeiron"><i class="svg-icon github"></i></a>








    </footer>
    

</body>
</html>