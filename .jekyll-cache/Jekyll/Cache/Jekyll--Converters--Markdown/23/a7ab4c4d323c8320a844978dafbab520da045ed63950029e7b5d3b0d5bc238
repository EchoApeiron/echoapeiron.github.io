I"<p>Onto what is currently the final installment of my Jellyfin server expedition. So far we have done some base server setup, configured the base application, did some networking to enable remote access, and deployed a reverse proxy to do our SSL offloading. Quite a bit, and if you need a review here are the links to the previous blog post:</p>

<ul>
  <li><a href="/Jellyfin-Initial">Jellyfin, Setting up the Server</a></li>
  <li><a href="/Jellyfin-SSL">Jellyfin, Securing with SSL Certificates</a></li>
</ul>

<p>Now we are going to do one other really cool thing and tie not only the application but our server into our central authentication server. For this we will be using the old trite and true Microsoft Active Directory. One Windows dominates with this technology and two it works very well out of the box with minimal configuration. We may touch on a few things like OUs, Users, and Groups. Beyond that though it will be assumed you have a Domain Controller or some sort of LDAP server already deployed. As we will be using LDAP specifically any LDAP server will be sufficient. You will need to know how to get your own Distinguished Names (or DNs as they are referred to sometimes).</p>

<h3 id="linux-and-active-directory">Linux and Active Directory</h3>

<p>I remember the first time I attempted to do this… and it was a massive failure back in 2010. While possible it was a difficult to achieve task. Then winbind got very mature and was doing work in conjunction with Samba. Now you will see just how simple it can be to tie  your Linux server to Active Directory. Which means you have no excuse to keep doing it going into the future.</p>

<p>First we need to install the required packages. The main biggies are going to be realmd, sssd, some PAM modules, and some other supplementary stuff for directory creation and the sorts. You can install the required software running the command below:</p>

<p><code class="language-plaintext highlighter-rouge">root@server:~# apt -y install realmd sssd sssd-tools libnss-sss libpam-sss adcli samba-common-bin oddjob oddjob-mkhomedir packagekit</code></p>

<p>Since Active Directory is very DNS driven we need to make sure we can communicate with the DNS server that is hosting the zone for our Active Directory. You can do this by using Netplan (which you may have used to configure your static… I didn’t for this for sake of ease). For this we just make a small config change to a YAML file in the Netplan configuration you can find it using the <code class="language-plaintext highlighter-rouge">ls</code> command on the <code class="language-plaintext highlighter-rouge">/etc/netplan</code> directory. Then simply back it up and edit as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp /etc/netplan/01-netcfg.yaml /etc/netplan/01-netcfg.yaml.bkup
vim /etc/netplan/01-netcfg.yaml
...

    nameservers:
      addresses: [192.168.0.100]

netplan apply 
</code></pre></div></div>

<p>One important fact about YAML is that tab characters are illegal. So be sure that you are indenting using only the spacebar or it will break the file. We then need to discover the domain using our <code class="language-plaintext highlighter-rouge">realm</code> command and should get an output like the following if everything is working properly, and your server can communicate with the Active Directory server’s DNS:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@hinata:/etc/netplan# realm discover domain.com
domain.com
  type: kerberos
  realm-name: DOMAIN.COM
  domain-name: domain.com
  configured: kerberos-member
  server-software: active-directory
  client-software: sssd
  required-package: sssd-tools
  required-package: sssd
  required-package: libnss-sss
  required-package: libpam-sss
  required-package: adcli
  required-package: samba-common-bin
  login-formats: %U
  login-policy: allow-realm-logins
</code></pre></div></div>

<p>With the domain discoverable this means we can then join it. To do so we are going to specify a user that isn’t the Administrator account (in my domain it is disabled). If you are using your Administrator account you don’t need to specify a user, but otherwise do as I do with the join command below:</p>

<p><code class="language-plaintext highlighter-rouge">realm join -U admin_user domain.com</code></p>

<p>You will then be prompted for the password. If everything worked you will get no notification which can be daunting but rest assured that’s good. If an error is thrown then that’s bad. Before we are able to test any users though we have to make some changes to PAM (Pluggable Authentication Module). Make a backup of the config file, but edit the file below as shown and then add the following entry as the very last line of the file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim /etc/pam.d/commoon-session
...

session optional        pam_mkhomedir.so skel=/etc/skel umask=077
</code></pre></div></div>

<p>https://www.server-world.info/en/note?os=Ubuntu_20.04&amp;p=realmd</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?xml version="1.0"?&gt;
&lt;PluginConfiguration xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema"&gt;
  &lt;LdapServer&gt;directory.server.com&lt;/LdapServer&gt;
  &lt;LdapBaseDn&gt;DC=server,DC=com&lt;/LdapBaseDn&gt;
  &lt;LdapPort&gt;389&lt;/LdapPort&gt;
  &lt;LdapSearchAttributes&gt;SamAccountName&lt;/LdapSearchAttributes&gt;
  &lt;LdapUsernameAttribute&gt;SamAccountName&lt;/LdapUsernameAttribute&gt;
  &lt;LdapSearchFilter&gt;(memberOf=CN=Jellyfin-Users,OU=O-Groups,DC=server,DC=com)&lt;/LdapSearchFilter&gt;
  &lt;LdapAdminFilter&gt;(memberOf=CN=Jellyfin-Admins,OU=O-Groups,DC=server,DC=com)&lt;/LdapAdminFilter&gt;
  &lt;LdapBindUser&gt;CN=Jellyfin LDAP,OU=Service-Accounts,OU=O-Users,DC=server,DC=com&lt;/LdapBindUser&gt;
  &lt;LdapBindPassword&gt;J3llyfin&lt;/LdapBindPassword&gt;
  &lt;CreateUsersFromLdap&gt;true&lt;/CreateUsersFromLdap&gt;
  &lt;UseSsl&gt;false&lt;/UseSsl&gt;
  &lt;UseStartTls&gt;false&lt;/UseStartTls&gt;
  &lt;SkipSslVerify&gt;false&lt;/SkipSslVerify&gt;
&lt;/PluginConfiguration&gt;
</code></pre></div></div>
:ET